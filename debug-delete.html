<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete Functionality Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Delete Functionality Debug Test</h1>
        
        <div class="alert alert-info">
            <h5>Testing Instructions:</h5>
            <ol>
                <li>Click "Create Test Resume" to add a test resume</li>
                <li>Click "Load Resumes" to see all resumes</li>
                <li>Try to delete a resume using the delete button</li>
                <li>Check the console logs for detailed debugging information</li>
            </ol>
        </div>
        
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary me-2" onclick="createTestResume()">Create Test Resume</button>
                <button class="btn btn-info me-2" onclick="loadResumes()">Load Resumes</button>
                <button class="btn btn-warning" onclick="clearLogs()">Clear Console Logs</button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <h3>Available Resumes</h3>
                <div id="resumesList"></div>
            </div>
            <div class="col-md-4">
                <h3>Console Logs</h3>
                <div id="consoleLogs" style="background: #f8f9fa; padding: 10px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
            </div>
        </div>
        
        <div class="alert alert-primary mt-3" id="statusAlert" style="display: none;"></div>
    </div>

    <script>
        // Console logging override
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToConsole(message, type = 'log') {
            const consoleDiv = document.getElementById('consoleLogs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            consoleDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        function clearLogs() {
            document.getElementById('consoleLogs').innerHTML = '';
        }

        function createTestResume() {
            const testData = {
                fullName: `Test User ${Date.now()}`,
                email: `test${Date.now()}@example.com`,
                phone: "1234567890",
                address: "123 Test Street",
                linkedin: "",
                github: "",
                portfolio: "",
                roleAppliedFor: "Software Developer",
                skills: "JavaScript, Node.js, Testing",
                careerObjective: "Test objective for delete functionality",
                education: {
                    "1": {
                        degree: "Bachelor of Science",
                        college: "Test University",
                        year: "2023"
                    }
                },
                experience: {
                    "1": {
                        company: "Test Company",
                        role: "Developer",
                        duration: "2023-2024",
                        description: "Test description"
                    }
                },
                certifications: "None",
                projects: "Test project for delete functionality"
            };

            console.log('Creating test resume...');
            
            fetch('/api/resume/input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                console.log('Create resume response status:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('Create resume result:', result);
                if (result.success) {
                    showStatus(`Test resume created successfully! ID: ${result.data.id}`, 'success');
                    loadResumes();
                } else {
                    showStatus('Error creating test resume: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error creating test resume:', error);
                showStatus('Error creating test resume', 'danger');
            });
        }

        function loadResumes() {
            console.log('Loading resumes...');
            
            fetch('/api/resume')
                .then(response => {
                    console.log('Load resumes response status:', response.status);
                    return response.json();
                })
                .then(result => {
                    console.log('Load resumes result:', result);
                    if (result.success) {
                        displayResumes(result.data);
                    } else {
                        showStatus('Error loading resumes: ' + result.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading resumes:', error);
                    showStatus('Error loading resumes', 'danger');
                });
        }

        function displayResumes(resumes) {
            const container = document.getElementById('resumesList');
            if (resumes.length === 0) {
                container.innerHTML = '<p class="text-muted">No resumes found</p>';
                return;
            }

            console.log(`Displaying ${resumes.length} resumes`);

            container.innerHTML = resumes.map(resume => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">${resume.name || 'Unnamed Resume'}</h6>
                        <p class="card-text small">
                            ${resume.email || 'No email'} - ${resume.roleAppliedFor || 'No role'}
                            <br>
                            <strong>ID:</strong> ${resume._id}
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-danger" onclick="deleteResume('${resume._id}', '${(resume.name || 'Unnamed Resume').replace(/'/g, '\\\'')}')" data-resume-id="${resume._id}">
                                üóëÔ∏è Delete
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="testDeleteDirectly('${resume._id}')">
                                üß™ Direct Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteResume(resumeId, resumeName) {
            console.log('Delete function called with:', { resumeId, resumeName });
            
            const confirmMessage = `Are you sure you want to delete the resume for "${resumeName}"? This action cannot be undone.`;
            console.log('Showing confirmation dialog:', confirmMessage);
            
            if (!confirm(confirmMessage)) {
                console.log('Delete cancelled by user');
                return;
            }

            console.log('User confirmed delete, proceeding...');
            console.log('Sending DELETE request to:', `/api/resume/${resumeId}`);

            fetch(`/api/resume/${resumeId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                console.log('Delete response headers:', [...response.headers.entries()]);
                return response.text().then(text => {
                    console.log('Delete response text:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Failed to parse JSON response:', e);
                        throw new Error('Invalid JSON response: ' + text);
                    }
                });
            })
            .then(result => {
                console.log('Delete result parsed:', result);
                if (result.success) {
                    showStatus(`Resume "${resumeName}" deleted successfully!`, 'success');
                    console.log('Delete successful, reloading resumes...');
                    setTimeout(() => {
                        loadResumes();
                    }, 1000);
                } else {
                    console.error('Delete failed:', result.message);
                    showStatus('Error deleting resume: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error in delete request:', error);
                showStatus('Error deleting resume: ' + error.message, 'danger');
            });
        }

        function testDeleteDirectly(resumeId) {
            console.log('Testing direct delete without confirmation for ID:', resumeId);
            
            fetch(`/api/resume/${resumeId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                console.log('Direct delete result:', result);
                if (result.success) {
                    showStatus('Direct delete successful!', 'success');
                    loadResumes();
                } else {
                    showStatus('Direct delete failed: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Direct delete error:', error);
                showStatus('Direct delete error: ' + error.message, 'danger');
            });
        }

        function showStatus(message, type) {
            console.log('Showing status:', message, type);
            const alert = document.getElementById('statusAlert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Load resumes when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            loadResumes();
        });
    </script>
</body>
</html>
